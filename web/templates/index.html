<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Amil - Interface Web</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¤– Bot Amil - Busca de Prestadores</h1>
            <p class="subtitle">Interface de controle e monitoramento</p>
        </header>

        <div class="card">
            <h2>ğŸ“Š Status da ExecuÃ§Ã£o</h2>
            <div id="status">
                <div class="status-row">
                    <span class="label">Status:</span>
                    <span id="status-text" class="status-badge">Aguardando...</span>
                </div>
                <div class="status-row">
                    <span class="label">Cidade atual:</span>
                    <span id="cidade-atual">-</span>
                </div>
                <div class="status-row">
                    <span class="label">Progresso:</span>
                    <span id="progresso">0</span> / <span id="total">0</span> cidades
                </div>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-fill"></div>
                    </div>
                    <span id="progress-percent" class="progress-text">0%</span>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ® Controles</h2>
            <!-- ğŸ”¥ NOVO â€” Mostrar progresso salvo -->
            <div id="progresso-info" style="margin-bottom: 15px; padding: 10px; background: #e3f2fd; border-radius: 5px; display: none;">
                <p><strong>ğŸ“Œ Ãšltima cidade processada:</strong> <span id="ultima-cidade">-</span></p>
                <button onclick="limparProgresso()" class="btn" style="background: #ff9800; color: white; margin-top: 5px;">ğŸ—‘ï¸ Limpar Progresso</button>
            </div>
            
            <div class="buttons">
                <button id="btn-iniciar" class="btn btn-success" onclick="iniciarBot(true)">
                    â–¶ï¸ Continuar de Onde Parou
                </button>
                <button id="btn-iniciar-zero" class="btn btn-success" onclick="iniciarBot(false)" style="background: #2196F3;">
                    ğŸ”„ ComeÃ§ar do Zero
                </button>
                <button id="btn-parar" class="btn btn-danger" onclick="pararBot()" disabled>
                    â¹ï¸ Parar ExecuÃ§Ã£o
                </button>
                <button class="btn btn-primary" onclick="downloadPlanilha()">
                    ğŸ“¥ Baixar Planilha Excel
                </button>
                <button class="btn btn-info" onclick="atualizarEstatisticas()">
                    ğŸ“Š Atualizar EstatÃ­sticas
                </button>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“ˆ EstatÃ­sticas</h2>
            <div id="estatisticas">
                <p>Total de PDFs: <strong id="total-pdfs">-</strong></p>
                <div id="estados-stats"></div>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“ Logs em Tempo Real</h2>
            <div id="logs" class="logs"></div>
        </div>
    </div>

    <script>
        let intervaloStatus;
        let ultimoErroMostrado = null; // ğŸ”¥ NOVO â€” Rastrear Ãºltimo erro mostrado

        function atualizarStatus() {
            fetch('/api/status')
                .then(r => r.json())
                .then(data => {
                    // Status
                    const statusText = document.getElementById('status-text');
                    if (data.rodando) {
                        statusText.textContent = 'ğŸŸ¢ Em execuÃ§Ã£o';
                        statusText.className = 'status-badge running';
                    } else {
                        statusText.textContent = 'ğŸ”´ Parado';
                        statusText.className = 'status-badge stopped';
                    }

                    // Cidade atual
                    document.getElementById('cidade-atual').textContent = 
                        data.cidade_atual ? `${data.cidade_atual}-${data.uf_atual}` : '-';

                    // Progresso
                    document.getElementById('progresso').textContent = data.progresso;
                    document.getElementById('total').textContent = data.total;
                    
                    const porcentagem = data.total > 0 ? (data.progresso / data.total) * 100 : 0;
                    document.getElementById('progress-fill').style.width = porcentagem + '%';
                    document.getElementById('progress-percent').textContent = Math.round(porcentagem) + '%';
                    
                    // BotÃµes
                    document.getElementById('btn-iniciar').disabled = data.rodando;
                    document.getElementById('btn-parar').disabled = !data.rodando;
                    
                    // ğŸ”¥ CORREÃ‡ÃƒO â€” Mostrar erro apenas uma vez e limpar no servidor
                    if (data.erro && data.erro !== ultimoErroMostrado) {
                        ultimoErroMostrado = data.erro;
                        alert('Erro: ' + data.erro);
                        // Limpar erro no servidor apÃ³s mostrar
                        fetch('/api/limpar-erro', {method: 'POST'}).catch(() => {});
                    } else if (!data.erro) {
                        // Se nÃ£o hÃ¡ mais erro, resetar rastreamento
                        ultimoErroMostrado = null;
                    }

                    // Logs
                    if (data.log && data.log.length > 0) {
                        const logsDiv = document.getElementById('logs');
                        logsDiv.innerHTML = data.log.slice(-50).reverse().map(log => 
                            `<div class="log-line">${log}</div>`
                        ).join('');
                    }
                    
                    // ğŸ”¥ NOVO â€” Atualizar progresso salvo periodicamente
                    atualizarProgressoInfo();
                })
                .catch(err => console.error('Erro ao atualizar status:', err));
        }

        function iniciarBot(continuarProgresso = true) {
            const mensagem = continuarProgresso 
                ? 'Deseja continuar de onde parou?' 
                : 'Deseja comeÃ§ar do zero? (Isso limparÃ¡ o progresso anterior)';
            
            if (!confirm(mensagem + '\n\nIsso pode levar vÃ¡rias horas.')) {
                return;
            }

            // Resetar rastreamento de erro
            ultimoErroMostrado = null;

            fetch('/api/iniciar', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({continuar_progresso: continuarProgresso})
            })
                .then(r => r.json())
                .then(data => {
                    alert(data.mensagem || data.erro);
                    if (!data.erro) {
                        // ğŸ”¥ CORREÃ‡ÃƒO â€” Limpar intervalo anterior antes de criar novo
                        if (intervaloStatus) {
                            clearInterval(intervaloStatus);
                        }
                        intervaloStatus = setInterval(atualizarStatus, 2000);
                    }
                })
                .catch(err => {
                    alert('Erro ao iniciar bot: ' + err);
                });
        }

        function pararBot() {
            if (!confirm('Deseja parar a execuÃ§Ã£o do bot?')) {
                return;
            }

            // ğŸ”¥ NOVO â€” Resetar rastreamento de erro
            ultimoErroMostrado = null;

            fetch('/api/parar', {method: 'POST'})
                .then(r => r.json())
                .then(data => {
                    // NÃ£o mostrar alert ao parar
                    if (intervaloStatus) {
                        clearInterval(intervaloStatus);
                    }
                    atualizarStatus();
                    // ğŸ”¥ CORREÃ‡ÃƒO â€” Recriar intervalo apÃ³s parar para continuar monitorando
                    intervaloStatus = setInterval(atualizarStatus, 2000);
                });
        }

        function limparProgresso() {
            if (!confirm('Deseja limpar o progresso salvo? Isso farÃ¡ o bot comeÃ§ar do zero na prÃ³xima execuÃ§Ã£o.')) {
                return;
            }

            fetch('/api/limpar-progresso', {method: 'POST'})
                .then(r => r.json())
                .then(data => {
                    alert(data.mensagem);
                    atualizarProgressoInfo();
                });
        }

        function atualizarEstatisticas() {
            console.log('ğŸ”„ Atualizando estatÃ­sticas...'); // ğŸ”¥ NOVO â€” Debug
            
            // ğŸ”¥ CORREÃ‡ÃƒO â€” Mostrar loading
            const totalPdfsEl = document.getElementById('total-pdfs');
            const estadosDiv = document.getElementById('estados-stats');
            totalPdfsEl.textContent = 'Carregando...';
            estadosDiv.innerHTML = '<span>Carregando...</span>';
            
            fetch('/api/estatisticas')
                .then(r => {
                    console.log('ğŸ“Š Resposta do servidor:', r.status); // ğŸ”¥ NOVO â€” Debug
                    if (!r.ok) {
                        throw new Error(`Erro HTTP: ${r.status}`);
                    }
                    return r.json();
                })
                .then(data => {
                    console.log('ğŸ“Š Dados recebidos:', data); // ğŸ”¥ NOVO â€” Debug
                    
                    // ğŸ”¥ CORREÃ‡ÃƒO â€” Verificar se hÃ¡ erro na resposta
                    if (data.erro) {
                        console.error('âŒ Erro ao buscar estatÃ­sticas:', data.erro);
                        totalPdfsEl.textContent = 'Erro';
                        estadosDiv.innerHTML = 
                            `<span style="color: red;">Erro: ${data.erro}</span>`;
                        return;
                    }
                    
                    totalPdfsEl.textContent = data.total_pdfs || 0;
                    
                    if (data.estados && Object.keys(data.estados).length > 0) {
                        estadosDiv.innerHTML = Object.entries(data.estados)
                            .map(([uf, count]) => `<span class="estado-badge">${uf}: ${count}</span>`)
                            .join('');
                    } else {
                        estadosDiv.innerHTML = '<span>Nenhum PDF encontrado</span>';
                    }
                })
                .catch(err => {
                    console.error('âŒ Erro ao buscar estatÃ­sticas:', err);
                    totalPdfsEl.textContent = 'Erro';
                    estadosDiv.innerHTML = 
                        `<span style="color: red;">Erro ao carregar: ${err.message}</span>`;
                });
        }

        function atualizarProgressoInfo() {
            fetch('/api/progresso')
                .then(r => {
                    if (!r.ok) {
                        throw new Error(`Erro HTTP: ${r.status}`);
                    }
                    return r.json();
                })
                .then(data => {
                    const infoDiv = document.getElementById('progresso-info');
                    const cidadeSpan = document.getElementById('ultima-cidade');
                    
                    if (data.progresso) {
                        cidadeSpan.textContent = `${data.progresso.cidade}-${data.progresso.uf}`;
                        infoDiv.style.display = 'block';
                    } else {
                        infoDiv.style.display = 'none';
                    }
                })
                .catch(err => {
                    console.error('Erro ao atualizar progresso:', err);
                    // NÃ£o mostrar erro, apenas nÃ£o atualizar
                });
        }

        function downloadPlanilha() {
            window.location.href = '/api/planilha';
        }

        // Inicializar
        atualizarStatus();
        atualizarEstatisticas();
        atualizarProgressoInfo();  // ğŸ”¥ NOVO
        // ğŸ”¥ CORREÃ‡ÃƒO â€” Criar intervalo apenas uma vez na inicializaÃ§Ã£o
        if (!intervaloStatus) {
            intervaloStatus = setInterval(atualizarStatus, 2000);
        }
    </script>
</body>
</html>
